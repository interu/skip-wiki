- content_for(:header) do
  =javascript_include_tag("fckeditor/fckeditor.js")

#content
  - div_for(@page) do
    %h1&= @page.display_name.blank? ? _("New Page") : @page.display_name
    .tab= render :partial => 'pages/navi', :locals=> {:current_path => new_note_page_history_path(current_note, @page)}

    - page_name = @page.name.blank? ? params[:id] : @page.name
    #linkPalette
      %span.trigger= _("Show link palette")

    - form_for(:history, @history, :url=>note_page_histories_path(current_note, @page)) do |f|
      %dl
        %dt
          = h(_("Page|Content"))
        %dd.content
          .previewable
            %ul
              %li.show
                %a.wii_button.show
                  %span&= _("Preview")

              %li.hide
                %a.wii_button
                  %span&= _("Hide")

            .rendered
            .clear
          = text_area_tag("history['content']", @page.content, :id=>"history_content", :size=>"80x70")

      %span.notice{:style=>"display:none"}&= _("Modified, need to save.")
      = submit_tag(_("Save"))
      = link_to(h(_("show page")), note_page_path(current_note, @page), :class=>"back")

:ruby
  editor_opt = {"basePath" => controller.request.relative_url_root + "/javascripts/fckeditor/",
                "initialState" => @page.format_type }

  palette_opt = {
    :editor => "history_content",
    :note_attachments => note_attachments_path(current_note),
    :page_attachments => note_page_attachments_path(current_note, @page),
    :insert_link_label => _("Insert Link"),
    :insert_image_label => _("Insert Image")
  }

:javascript
  $(document).ready(function(){
    // jQuery(".previewable").preview({"url":"#{preview_new_note_page_path(current_note.id)}"});
    jQuery("#history_content").editor(#{editor_opt.to_json});
    jQuery("#linkPalette").linkPalette(#{palette_opt.to_json})
  });

  function FCKeditor_OnComplete( editorInstance ){
    editorInstance.Events.AttachEvent( 'OnSelectionChange', function (editorInstance){
      if(editorInstance.IsDirty()){
        jQuery(".page form").find("input[type=submit]").enable().end().find("span.notice").show();
      }else{
        jQuery(".page form").find("input[type=submit]").disable().end().find("span.notice").hide();
      }
    });
  }

